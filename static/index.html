<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI æ™ºèƒ½çŸ¥è¯†åº“ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
      }
      
      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      }
      
      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }
      
      .card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin: 20px 0;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.15);
      }
      
      .card h3 {
        color: #2d3748;
        margin-bottom: 16px;
        font-size: 1.3rem;
        font-weight: 600;
        display: flex;
        align-items: center;
      }
      
      .card h3::before {
        content: '';
        width: 4px;
        height: 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        margin-right: 12px;
        border-radius: 2px;
      }
      
      .form-group {
        margin-bottom: 16px;
      }
      
      .form-row {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      
      input, select, textarea {
        font-size: 14px;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-family: inherit;
      }
      
      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      input[type="file"] {
        padding: 8px;
        background: #f7fafc;
      }
      
      input[type="number"] {
        width: 100px;
      }
      
      button {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }
      
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }
      
      button:active {
        transform: translateY(0);
      }
      
      button.secondary {
        background: linear-gradient(135deg, #718096, #4a5568);
        box-shadow: 0 4px 15px rgba(113, 128, 150, 0.3);
      }
      
      button.secondary:hover {
        box-shadow: 0 6px 20px rgba(113, 128, 150, 0.4);
      }
      
      button.danger {
        background: linear-gradient(135deg, #fc8181, #f56565);
        box-shadow: 0 4px 15px rgba(252, 129, 129, 0.3);
      }
      
      button.danger:hover {
        box-shadow: 0 6px 20px rgba(252, 129, 129, 0.4);
      }
      
      .output {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 13px;
        line-height: 1.5;
        max-height: 300px;
        overflow-y: auto;
      }
      
      .answer-box {
        background: linear-gradient(135deg, #edf2f7, #e2e8f0);
        border-radius: 12px;
        padding: 20px;
        margin-top: 16px;
      }
      
      .answer-content {
        background: #2d3748;
        color: #c9e0ff;
        padding: 16px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 12px;
      }
      .answer-content h1,.answer-content h2,.answer-content h3,.answer-content h4,.answer-content h5,.answer-content h6{color:#c9e0ff;margin-top:0.5em;margin-bottom:0.3em}
      .answer-content p{margin:0.3em 0}
      .answer-content pre{background:#1a202c;padding:0.5em;border-radius:4px;overflow:auto}
      .answer-content code{background:#1a202c;padding:0.2em 0.4em;border-radius:3px;font-family:'Monaco','Menlo','Ubuntu Mono',monospace;font-size:13px}
      .answer-content ul,.answer-content ol{margin:0.3em 0 0.3em 1.2em}
      
      .answer-sources {
        color: #4a5568;
        font-size: 12px;
        font-style: italic;
      }
      
      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
        background: #48bb78;
      }
      
      .status-indicator.loading {
        background: #ed8936;
        animation: pulse 1.5s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      .kb-selector {
        min-width: 150px;
      }
      
      .full-width {
        width: 100%;
      }
      
      .large-input {
        width: 70%;
      }
      
      .medium-input {
        width: 45%;
      }
      
      .small-input {
        width: 30%;
      }
      
      @media (max-width: 768px) {
        .header h1 {
          font-size: 2rem;
        }
        
        .form-row {
          flex-direction: column;
          align-items: stretch;
        }
        
        .large-input, .medium-input, .small-input {
          width: 100%;
        }
        
        input[type="number"] {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ§  AI æ™ºèƒ½çŸ¥è¯†åº“ç³»ç»Ÿ</h1>
        <p>åŸºäº FastAPI + LangChain + Ollama çš„æ™ºèƒ½é—®ç­”å¹³å°</p>
      </div>

      <div class="card">
        <h3>ğŸ“š çŸ¥è¯†åº“ç®¡ç†</h3>
        <div class="form-row">
          <input id="kbName" class="medium-input" placeholder="è¾“å…¥çŸ¥è¯†åº“åç§°ï¼ˆå¦‚ï¼šæŠ€æœ¯æ–‡æ¡£ï¼‰" />
          <button onclick="createKb()">âœ¨ åˆ›å»ºçŸ¥è¯†åº“</button>
          <button onclick="loadKbs()" class="secondary">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
          <select id="kbSelect" class="kb-selector">
            <option value="">é€‰æ‹©çŸ¥è¯†åº“</option>
          </select>
          <button onclick="delKb()" class="danger">ğŸ—‘ï¸ åˆ é™¤</button>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ“ æ–‡ä»¶ä¸Šä¼ </h3>
        <div class="form-group">
          <input id="files" type="file" multiple class="full-width" />
          <small style="color: #718096;">æ”¯æŒæ ¼å¼ï¼š.txt, .md, .py, .java, .sql, .csv, .json</small>
        </div>
        <button onclick="uploadFiles()">ğŸ“¤ ä¸Šä¼ å¹¶å¤„ç†</button>
        <div id="uploadOut" class="output" style="display: none;"></div>
      </div>

      <div class="card">
        <h3>ğŸŒ Git ä»“åº“å¯¼å…¥</h3>
        <div class="form-group">
          <input id="gitUrl" class="large-input" placeholder="https://github.com/ç”¨æˆ·å/ä»“åº“å.git" />
        </div>
        <div class="form-row">
          <input id="gitBranch" class="small-input" placeholder="åˆ†æ”¯ï¼ˆå¯é€‰ï¼‰" />
          <input id="gitUser" class="small-input" placeholder="ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰" />
          <input id="gitToken" class="small-input" placeholder="ä»¤ç‰Œï¼ˆå¯é€‰ï¼‰" />
        </div>
        <button onclick="ingestGit()">ğŸ”„ å¯¼å…¥ä»“åº“</button>
        <div id="gitOut" class="output" style="display: none;"></div>
      </div>

      <div class="card">
        <h3>ğŸ’¬ æ™ºèƒ½é—®ç­”</h3>
        <div class="form-group">
          <textarea id="question" rows="4" class="full-width" placeholder="åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„é—®é¢˜ï¼ŒAI å°†åŸºäºçŸ¥è¯†åº“å†…å®¹ä¸ºæ‚¨æä¾›ç­”æ¡ˆ..."></textarea>
        </div>
        <div class="form-row">
          <div style="display: flex; align-items: center;">
            <span style="margin-right: 8px;">è¿”å›ç»“æœæ•°é‡ï¼š</span>
            <input id="topk" type="number" value="4" min="1" max="10" />
          </div>
          <button onclick="ask()">ğŸš€ æäº¤é—®é¢˜</button>
        </div>
        <div id="answer" class="answer-box" style="display: none;">
          <div class="answer-content" id="answerContent"></div>
          <div class="answer-sources" id="answerSources"></div>
        </div>
      </div>
    </div>

    <script>
      let currentKb = '';

      async function loadKbs(){
        try {
          const r = await fetch('/kb');
          const j = await r.json();
          const sel = document.getElementById('kbSelect');
          sel.innerHTML = '<option value="">é€‰æ‹©çŸ¥è¯†åº“</option>';
          (j.items||[]).forEach(name => {
            const o = document.createElement('option'); 
            o.value = name; 
            o.textContent = name; 
            sel.appendChild(o);
          });
          if (currentKb && j.items.includes(currentKb)) {
            sel.value = currentKb;
          }
        } catch (error) {
          console.error('åŠ è½½çŸ¥è¯†åº“å¤±è´¥:', error);
        }
      }

      async function createKb(){
        const name = document.getElementById('kbName').value.trim();
        if(!name) return alert('è¯·è¾“å…¥çŸ¥è¯†åº“åç§°');
        
        try {
          const response = await fetch('/kb', {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({name})
          });
          
          if (response.ok) {
            document.getElementById('kbName').value = '';
            await loadKbs();
            // è‡ªåŠ¨é€‰æ‹©æ–°åˆ›å»ºçš„çŸ¥è¯†åº“
            document.getElementById('kbSelect').value = name;
            currentKb = name;
            alert('âœ… çŸ¥è¯†åº“åˆ›å»ºæˆåŠŸï¼');
          } else {
            alert('âŒ åˆ›å»ºçŸ¥è¯†åº“å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        } catch (error) {
          alert('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
        }
      }

      async function delKb(){
        const sel = document.getElementById('kbSelect');
        if(!sel.value) return alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„çŸ¥è¯†åº“');
        
        if (!confirm(`ç¡®å®šè¦åˆ é™¤çŸ¥è¯†åº“ "${sel.value}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
          return;
        }
        
        try {
          const response = await fetch('/kb/' + sel.value, {method: 'DELETE'});
          if (response.ok) {
            currentKb = '';
            await loadKbs();
            alert('âœ… çŸ¥è¯†åº“åˆ é™¤æˆåŠŸï¼');
          } else {
            alert('âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        } catch (error) {
          alert('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
        }
      }

      async function uploadFiles(){
        const sel = document.getElementById('kbSelect');
        if(!sel.value) return alert('è¯·å…ˆé€‰æ‹©çŸ¥è¯†åº“');
        
        const files = document.getElementById('files').files;
        if (files.length === 0) return alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
        
        const fd = new FormData();
        for(const f of files) { 
          fd.append('files', f); 
        }
        
        const output = document.getElementById('uploadOut');
        output.style.display = 'block';
        output.textContent = 'ğŸ“¤ æ­£åœ¨ä¸Šä¼ å’Œå¤„ç†æ–‡ä»¶ï¼Œè¯·ç¨å€™...';
        
        try {
          const r = await fetch(`/kb/${sel.value}/upload`, {method: 'POST', body: fd});
          const j = await r.json();
          output.textContent = JSON.stringify(j, null, 2);
          if (r.ok) {
            alert('âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼');
            document.getElementById('files').value = '';
          }
        } catch (error) {
          output.textContent = 'âŒ ä¸Šä¼ å¤±è´¥: ' + error.message;
        }
      }

      async function ingestGit(){
        const sel = document.getElementById('kbSelect');
        if(!sel.value) return alert('è¯·å…ˆé€‰æ‹©çŸ¥è¯†åº“');
        
        const gitUrl = document.getElementById('gitUrl').value.trim();
        if (!gitUrl) return alert('è¯·è¾“å…¥ Git ä»“åº“åœ°å€');
        
        const output = document.getElementById('gitOut');
        output.style.display = 'block';
        output.textContent = 'ğŸ”„ æ­£åœ¨å¯¼å…¥ Git ä»“åº“ï¼Œè¯·ç¨å€™...';
        
        const body = {
          repo_url: gitUrl, 
          branch: document.getElementById('gitBranch').value.trim() || null, 
          username: document.getElementById('gitUser').value.trim() || null, 
          token: document.getElementById('gitToken').value.trim() || null
        };
        
        try {
          const r = await fetch(`/kb/${sel.value}/git`, {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(body)
          });
          const j = await r.json();
          output.textContent = JSON.stringify(j, null, 2);
          if (r.ok) {
            alert('âœ… Git ä»“åº“å¯¼å…¥æˆåŠŸï¼');
            document.getElementById('gitUrl').value = '';
            document.getElementById('gitBranch').value = '';
            document.getElementById('gitUser').value = '';
            document.getElementById('gitToken').value = '';
          }
        } catch (error) {
          output.textContent = 'âŒ å¯¼å…¥å¤±è´¥: ' + error.message;
        }
      }

      async function ask(){
        const sel = document.getElementById('kbSelect');
        if(!sel.value) return alert('è¯·å…ˆé€‰æ‹©çŸ¥è¯†åº“');
        
        const question = document.getElementById('question').value.trim();
        if (!question) return alert('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜');
        
        const answerBox = document.getElementById('answer');
        const answerContent = document.getElementById('answerContent');
        const answerSources = document.getElementById('answerSources');
        
        answerBox.style.display = 'block';
        answerContent.textContent = 'ğŸ¤” AI æ­£åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨å€™...';
        answerSources.textContent = '';
        
        const body = {
          kb: sel.value, 
          question: question, 
          top_k: parseInt(document.getElementById('topk').value) || 4
        };
        
        try {
          const r = await fetch('/chat', {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(body)
          });
          const j = await r.json();
          
          if (r.ok && j.answer) {
            answerContent.innerHTML = marked.parse(j.answer);
            if (j.sources && j.sources.length > 0) {
              answerSources.textContent = 'ğŸ“š å‚è€ƒæ¥æº: ' + j.sources.map(s => s.source).join(', ');
            } else {
              answerSources.textContent = 'ğŸ“š æœªæ‰¾åˆ°ç›¸å…³å‚è€ƒæ¥æº';
            }
          } else {
            answerContent.textContent = 'âŒ è·å–ç­”æ¡ˆå¤±è´¥: ' + (j.error || 'æœªçŸ¥é”™è¯¯');
          }
        } catch (error) {
          answerContent.textContent = 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
        }
      }

      // ç›‘å¬çŸ¥è¯†åº“é€‰æ‹©å˜åŒ–
      document.getElementById('kbSelect').addEventListener('change', function() {
        currentKb = this.value;
      });

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      loadKbs();
    </script>
  </body>
</html>
